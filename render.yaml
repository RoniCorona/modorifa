services:
  - type: web
    name: rifas-app
    env: node
    plan: free
    rootDir: backend
    buildCommand: |
      echo "ğŸ“ Current directory: $(pwd)"
      echo "ğŸ“‚ Listing contents of repo root:"
      ls -la ..
      
      echo "ğŸ“¦ Moving into admin-frontend..."
      cd ../admin-frontend

      if [ -f package-lock.json ]; then
        echo "ğŸ“¥ Running npm ci..."
        npm ci
      else
        echo "ğŸ“¥ Running npm install..."
        npm install
      fi

      echo "ğŸ—ï¸ Running Vite build..."
      npm run build

      echo "ğŸ“ Listing build output:"
      ls -la dist

      echo "ğŸ“‚ Creating admin folder in backend if missing..."
      mkdir -p ../backend/admin

      echo "ğŸ§¹ Clearing previous admin contents..."
      rm -rf ../backend/admin/*

      echo "ğŸ“‹ Copying new build files to backend/admin..."
      cp -r dist/* ../backend/admin/
    startCommand: node server.js
    envVars:
      - key: MONGO_URI
        value: mongodb+srv://RoniCorona:22121997@rifascluster.iqlewr4.mongodb.net/RifasDB?retryWrites=true&w=majority&appName=RifasCluster
      - key: PORT
        value: 10000
      - key: ALLOWED_ORIGINS
        value: https://rifas-app.onrender.com,http://localhost:5000
    buildFilter:
      paths:
        - backend/**
        - admin-frontend/**
        - index.html
        - rifa.html
        - script.js
    autoDeploy: true
